FROM node:20-alpine AS frontend-builder

ARG TUNNEL_DOMAIN=""

RUN apk add --no-cache git curl

WORKDIR /app

RUN git clone https://github.com/noatgnu/cupcake-webgui.git .

RUN if [ -n "$TUNNEL_DOMAIN" ]; then \
      sed -i "s|https://localhost|https://${TUNNEL_DOMAIN}|g" src/environments/environment.ts && \
      sed -i "s|wss://localhost|wss://${TUNNEL_DOMAIN}|g" src/environments/environment.ts && \
      sed -i "s|production: false|production: true|g" src/environments/environment.ts; \
    else \
      sed -i "s|https://localhost|http://localhost:8000|g" src/environments/environment.ts && \
      sed -i "s|wss://localhost|ws://localhost:8000|g" src/environments/environment.ts; \
    fi

RUN echo "=== Updated environment.ts ===" && cat src/environments/environment.ts

RUN npm ci

RUN npm run build

RUN ls -la dist/ && ls -la dist/cupcake/

FROM nginx:alpine

RUN apk add --no-cache curl moreutils

ARG NGINX_SERVER_NAME="_"
ENV NGINX_SERVER_NAME=${NGINX_SERVER_NAME}

COPY ./dockerfiles/nginx-demo-frontend.conf /etc/nginx/conf.d/default.conf

COPY --from=frontend-builder /app/dist/cupcake/browser /usr/share/nginx/html

RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chown -R nginx:nginx /var/cache/nginx && \
    chown -R nginx:nginx /var/log/nginx && \
    chown -R nginx:nginx /etc/nginx/conf.d

RUN touch /var/run/nginx.pid && \
    chown -R nginx:nginx /var/run/nginx.pid

USER nginx

EXPOSE 80

CMD ["sh", "-c", "envsubst '$$NGINX_SERVER_NAME' < /etc/nginx/conf.d/default.conf | sponge /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]
