FROM nginx:alpine

# Install certbot
RUN apk add --no-cache certbot

# Create directories for webroot and certificates
RUN mkdir -p /var/www/certbot /etc/letsencrypt

# Create a simple nginx configuration for ACME challenges
RUN echo 'server { \
    listen 80; \
    server_name _; \
    location /.well-known/acme-challenge/ { \
        root /var/www/certbot; \
        try_files $uri =404; \
    } \
    location / { \
        return 200 "ACME challenge server running"; \
        add_header Content-Type text/plain; \
    } \
}' > /etc/nginx/conf.d/default.conf

# Create entrypoint script with proper line breaks
COPY <<EOF /entrypoint.sh
#!/bin/sh
set -e

echo "Starting nginx for ACME challenges..."
nginx -g "daemon off;" &
NGINX_PID=\$!

echo "Waiting for nginx to start..."
sleep 3

echo "Running certbot for domain: \$DOMAIN"
echo "Using email: \$CERTBOT_EMAIL"

certbot certonly \\
    --webroot \\
    --webroot-path=/var/www/certbot \\
    --non-interactive \\
    --email "\$CERTBOT_EMAIL" \\
    --agree-tos \\
    --no-eff-email \\
    --force-renewal \\
    --domains "\$DOMAIN"

echo "Certificate generation completed!"
echo "Stopping nginx..."
kill \$NGINX_PID
wait \$NGINX_PID 2>/dev/null || true

echo "Done!"
EOF

RUN chmod +x /entrypoint.sh

EXPOSE 80

ENTRYPOINT ["/entrypoint.sh"]
